<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Material Design Lite</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/android-desktop.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="/images/ios-desktop.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="shortcut icon" href="/images/favicon.png">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-pink.min.css">
    <link rel="stylesheet" href="/stylesheets/styles-article.css">
    <style>
        .replyContent{
            display: none;
        }
        .articleArea{
            overflow-x: auto;
            overflow-y: auto;
        }
        .mdl-dialog__title{
            font-size: 1.5rem;
        }
        #more-fab {
            position: fixed;
            display: block;
            right: 0;
            bottom: 0;
            margin-right: 40px;
            margin-bottom: 40px;
            z-index: 900;
        }
    </style>
</head>
<body>
<div class="demo-layout mdl-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100">
    <header class="demo-header mdl-layout__header mdl-layout__header--scroll mdl-color--grey-100 mdl-color-text--grey-800">
        <div class="mdl-layout__header-row">
            <a class="mdl-layout-title" href="/article/articlePage" style="text-decoration:none;color:#424242">CHSH的博客</a>
            <div class="mdl-layout-spacer"></div>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
                <label class="mdl-button mdl-js-button mdl-button--icon" for="search">
                    <i class="material-icons">search</i>
                </label>
                <div class="mdl-textfield__expandable-holder">
                    <input class="mdl-textfield__input" type="text" id="search">
                    <label class="mdl-textfield__label" for="search">Enter your query...</label>
                </div>
            </div>
        </div>
    </header>
    <div class="demo-ribbon"></div>
    <main class="demo-main mdl-layout__content">
        <div class="demo-container mdl-grid">
            <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
            <div class="demo-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col articleArea">
                <div class="demo-crumbs mdl-color-text--grey-500">
                    CHSH &gt; 文章列表 &gt; <%=articleDetail.articleTitle%>
                </div>
                <h1 id="rxjs-66-70-"><%=articleDetail.articleTitle%></h1>
                <%-articleDetail.articleContent%>
            </div>
        </div>
        <!--评论部分-->
        <div class="demo-container mdl-grid">
            <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
            <div class="demo-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
        <%if(articleComment.length!==0){%>
                <h2 id="rxjs-66-70-">评论区域</h2>
                <ul class="demo-list-three mdl-list ">
                        <%for(var i=0;i<articleComment.length;i++){%>
                            <li class="mdl-list__item mdl-list__item--three-line">
    <span class="mdl-list__item-primary-content">
      <i class="material-icons mdl-list__item-avatar">person</i>
      <span id="commentAuthor"><%=articleComment[i].commentAuthor%></span>的评论
      <span class="mdl-list__item-text-body">
          <%=articleComment[i].commentContent%>
      </span>
        <!--用于存储评论ID-->
        <p  id="commentId" style="display:none"><%=articleComment[i].commentId%></p>
    </span>
                                <span class="mdl-list__item-secondary-content">

      <a class="mdl-list__item-secondary-action show-dialog replyCommentModal" href="#" ><i class="material-icons">reply</i></a>
                             <span class="mdl-list__item-secondary-info">Reply</span>
    </span>
                                <span class="mdl-list__item-secondary-content">

      <a class="mdl-list__item-secondary-action moreBtn" href="#"><i class="material-icons">list</i></a>
                             <span class="mdl-list__item-secondary-info">More</span>
    </span>
                            </li>
                    <!--回复部分-->
                    <%if(articleReply[i].length!==0){%>

                    <div class="mdl-grid replyContent">
                        <ul class="demo-list-two mdl-list mdl-cell mdl-cell--8-col">
                            <%for(var j=0;j<articleReply[i].length;j++){%>
                            <li class="mdl-list__item mdl-list__item--two-line">
    <span class="mdl-list__item-primary-content">
      <i class="material-icons mdl-list__item-avatar">person</i>

        <span id="replyAuthor"><%=articleReply[i][j].replyAuthor%></span>回复<span ><%=articleReply[i][j].beRepliedAuthor%></span>
        <!--该项用于存储replyCommentId-->
        <p  id="replyCommentId" style="display:none"><%=articleComment[i].commentId%></p>
      <span class="mdl-list__item-sub-title"><%=articleReply[i][j].replyContent%></span>
    </span>
                                <span class="mdl-list__item-secondary-content">

      <a class="mdl-list__item-secondary-action show-dialog replyReplyModal" href="#"><i class="material-icons">reply</i></a>
      <span class="mdl-list__item-secondary-info">Reply</span>
                            </span>
                            </li>
                            <%}%>
                        </ul>
                    </div>

                      <%}%>
                        <%}%>
                    <%}%>
                </ul>
                <!-- Expandable Textfield -->
                <!--提交评论-->
                <div class="mdl-grid">
                    <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
                        <div class="mdl-textfield mdl-js-textfield">
                            <textarea  id="commentContent" class="mdl-textfield__input" type="text" rows= "3" id="sample5" ></textarea>
                            <label class="mdl-textfield__label" for="sample5">有什么想对作者说</label>
                        </div>
                    </div>
                    <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
                    <!-- Accent-colored raised button with ripple -->
                <button  id="submitCommentButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
                    提交评论
                </button>
                    </div>
                </div>
                </div>
        </div>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer__left-section">
                <div class="mdl-logo">CHSH'sBlog</div>
                <ul class="mdl-mini-footer__link-list">
                    <li><a href="/mdl">We Use Google Material Degisn Lite</a></li>
                    <li><a href="#">ZUCC-CHSH Group</a></li>
                </ul>
            </div>
        </footer>
    </main>


</div>
<!--提交回复-->
<dialog class="mdl-dialog">
    <h6 class="mdl-dialog__title">回复内容</h6>
    <div class="mdl-dialog__content">
        <!--<p>-->
            <!--Allowing us to collect data will let us get you the information you want faster.-->
        <!--</p>-->
        <div class="mdl-textfield mdl-js-textfield">
            <textarea class="mdl-textfield__input replyContent" type="text" rows= "3" id="sample5" ></textarea>
            <label class="mdl-textfield__label" for="sample5">请输入回复的内容</label>
        </div>
    </div>
    <div class="mdl-dialog__actions">
        <button type="button" class="mdl-button submitReply">提交回复</button>
        <button type="button" class="mdl-button close">取消</button>
    </div>
</dialog>
<ul class="mdl-menu  mdl-menu--top-right mdl-js-menu mdl-js-ripple-effect" for="more-fab" style="margin-bottom: 10px;">
    <!--<li class="mdl-menu__item">个人信息</li>-->
    <a class="mdl-menu__item" href="/users/loginPage" id="login-item" style="color: black">登录</a>
    <a class="mdl-menu__item" href="/users/logout" id="logout" style="color: black">登出</a>
    <!--<li class="mdl-menu__item" id="ToTop">返回顶部</li>-->
</ul>
<a id="more-fab" class="mdl-button mdl-js-button  mdl-js-ripple-effect mdl-color--accent mdl-color-text--accent-contrast">未登陆</a>
<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="/js/jquery-3.3.1.js"></script>
<script src="/js/jquerysession.js"></script>
<script type="text/javascript">
    var dialog = document.querySelector('dialog');
    if (! dialog.showModal) {
        dialogPolyfill.registerDialog(dialog);
    }
    $(document).ready(function () {
        $(".show-dialog").click(function () {

            dialog.showModal();
        })
        $('.close').click(function () {
            dialog.close();
        })
    })

</script>
<script type="text/javascript">
    $(document).ready(function () {
        Date.prototype.format = function (format) {
            var args = {
                "M+": this.getMonth() + 1,
                "d+": this.getDate(),
                "h+": this.getHours(),
                "m+": this.getMinutes(),
                "s+": this.getSeconds(),
                "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
                "S": this.getMilliseconds()
            };
            if (/(y+)/.test(format))
                format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var i in args) {
                var n = args[i];
                if (new RegExp("(" + i + ")").test(format))
                    format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? n : ("00" + n).substr(("" + n).length));
            }
            return format;
        };

          var articleId=parseInt(<%=articleDetail.articleId%>);
               $.session.set('author',$.session.get('user'));
        $(".moreBtn").click(function (){
            $(this).parent().parent().next(".replyContent").slideToggle(800);
            // $("#comment1").slideToggle(800);
        })
        $("#submitCommentButton").click(function(){
            if($.session.get('user')===undefined){
                window.location.href='/users/loginPage';
            }
            else {
                var currentTime = new Date().format("yyyy-MM-dd hh:mm:ss");
                var commentContent = $("#commentContent").val();
                $.ajax({
                    data: {
                        commentContent: commentContent,
                        commentAuthor: $.session.get('author'),
                        commentTime: currentTime,
                        articleId: articleId
                    },
                    type: "POST",
                    url: "/article/addComment",
                    success: function (msg) {
                        alert(msg);
                        window.location.href = "http://127.0.0.1:3000/article/articleDetail/<%= articleDetail.articleId %>";
                    },
                    error: function () {
                        alert("error");
                    }
                })
            }
        })
        $(".replyCommentModal").click(function () {
            if($.session.get('user')===undefined){
                window.location.href='/users/loginPage';
            }
            else {
                //获得评论的Id
                var commentId = $(this).parent().parent().children(".mdl-list__item-primary-content").children("#commentId").text();
                var commentAuthor = $(this).parent().parent().children(".mdl-list__item-primary-content").children("#commentAuthor").text();
                $.session.set("beRepliedAuthor", commentAuthor);
                $.session.set("commentId", commentId);
            }
        })
        $(".replyReplyModal").click(function(){
            if($.session.get('user')===undefined){
                window.location.href='/users/loginPage';
            }
            else {
                //获得回复中评论的Id
                var replyCommentId = $(this).parent().parent().children(".mdl-list__item-primary-content").children("#replyCommentId").text();
                //获得被回复的作者名字
                var replyAuthor = $(this).parent().parent().children(".mdl-list__item-primary-content").children("#replyAuthor").text();
                $.session.set("beRepliedAuthor", replyAuthor);
                $.session.set("commentId", replyCommentId);
            }
        })
        $(".submitReply").click(function () {
            var currentTime=new  Date().format("yyyy-MM-dd hh:mm:ss");
            var commentId=$.session.get("commentId");
            var replyAuthor=$.session.get("author");
            var beRepliedAuthor=$.session.get("beRepliedAuthor");
            var replyContent=$(this).parent().parent().children(".mdl-dialog__content").children(".mdl-js-textfield").children(".replyContent").val();
            $.ajax({
                data:{
                    replyTime:currentTime,
                    replyAuthor:replyAuthor,
                    beRepliedAuthor: beRepliedAuthor,
                    replyContent:replyContent,
                    commentId:commentId
                },
                type:"POST",
                url:"/article/addReply",
                success:function (msg) {
                    alert(msg);
                    window.location.href = "http://127.0.0.1:3000/article/articleDetail/<%=articleDetail.articleId%>";
                },
                error:function () {

                }
            })

        })
    })
</script>
<script type="text/javascript" src="/js/jquerysession.js"></script>

<script>
    $(document).ready(function () {
        if($.session.get('user')===undefined||$.session.get('role')==='visitor'){
            $('#submitArticle').remove();
            $("#more-fab").text("未登陆");
        }
        if($.session.get('user')!=undefined){
            $("#more-fab").text('你好 '+$.session.get('user'));
            $("#login-item").remove();
        }
        $("#ToTop").click(function () {
            // $('html, body').animate({scrollTop: 0}, 500);
            scrollTo(0,0)
            // alert("click")
        })
        $("#logout").click(function () {
            $.session.clear();
        })
    })
</script>
</body>
</html>
